<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIæ”¹å˜äººç‰©åŠ¨ä½œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        /* å¤´éƒ¨ */
        .header {
            text-align: center;
            padding: 20px 0;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* å¯¼èˆªé“¾æ¥ */
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* å†…å®¹å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #f5576c;
            background: #fff0f3;
        }

        .upload-area.dragover {
            border-color: #f5576c;
            background: #ffe8ec;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
        }

        .file-input {
            display: none;
        }

        /* æ–‡ä»¶é¢„è§ˆ */
        .file-preview {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .file-preview.show {
            display: block;
        }

        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            font-size: 32px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            word-break: break-all;
        }

        .file-size {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .file-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æç¤ºè¯è¾“å…¥ */
        .prompt-area {
            margin-top: 10px;
        }

        .prompt-label {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .prompt-hint {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .prompt-input {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #f5576c;
        }

        .prompt-examples {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .prompt-example {
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 15px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prompt-example:hover {
            background: #f5576c;
            color: white;
        }

        /* æŒ‰é’® */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* è¿›åº¦åŒºåŸŸ */
        .progress-area {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            text-align: center;
        }

        .progress-area.show {
            display: block;
        }

        .progress-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #f5576c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-text {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .progress-status {
            font-size: 12px;
            color: #f5576c;
        }

        /* ç»“æœåŒºåŸŸ */
        .result-area {
            display: none;
            margin-top: 20px;
        }

        .result-area.show {
            display: block;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .result-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .result-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .result-actions {
            display: flex;
            gap: 10px;
        }

        .btn-download {
            flex: 1;
            padding: 10px;
            background: #f5576c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #ff4757;
        }

        .toast.success {
            background: #2ed573;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ’ƒ AIæ”¹å˜äººç‰©åŠ¨ä½œ</h1>
            <p>ä¸Šä¼ äººç‰©ç…§ç‰‡ï¼Œé€šè¿‡æç¤ºè¯æ”¹å˜äººç‰©åŠ¨ä½œå’Œå§¿æ€</p>
        </div>

        <!-- å¯¼èˆªé“¾æ¥ -->
        <div class="nav-links">
            <a href="/" class="nav-link">â† è¿”å›å»æ°´å°</a>
        </div>

        <!-- ä¸Šä¼ åŸå›¾ -->
        <div class="card">
            <div class="card-title">
                <div class="icon">ğŸ–¼ï¸</div>
                ä¸Šä¼ åŸå›¾ï¼ˆå›¾1ï¼‰
            </div>

            <div class="upload-area" id="source-image-upload">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ åŸå›¾</div>
                <div class="upload-hint">æ”¯æŒ PNG, JPG, JPEG æ ¼å¼</div>
            </div>
            <input type="file" class="file-input" id="source-image-input" accept="image/*">

            <div class="file-preview" id="source-image-preview">
                <img class="preview-image" id="source-preview-img" src="" alt="é¢„è§ˆ">
                <div class="file-info">
                    <div class="file-icon">ğŸ–¼ï¸</div>
                    <div class="file-details">
                        <div class="file-name" id="source-image-filename"></div>
                        <div class="file-size" id="source-image-filesize"></div>
                    </div>
                    <button class="file-remove" id="source-image-remove">Ã—</button>
                </div>
            </div>
        </div>

        <!-- ä¸Šä¼ å§¿åŠ¿å‚è€ƒå›¾ -->
        <div class="card">
            <div class="card-title">
                <div class="icon">ğŸ§</div>
                ä¸Šä¼ å§¿åŠ¿å‚è€ƒå›¾ï¼ˆå›¾2ï¼‰
            </div>

            <div class="upload-area" id="pose-image-upload">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å§¿åŠ¿å‚è€ƒå›¾</div>
                <div class="upload-hint">æ”¯æŒ PNG, JPG, JPEG æ ¼å¼</div>
            </div>
            <input type="file" class="file-input" id="pose-image-input" accept="image/*">

            <div class="file-preview" id="pose-image-preview">
                <img class="preview-image" id="pose-preview-img" src="" alt="é¢„è§ˆ">
                <div class="file-info">
                    <div class="file-icon">ğŸ§</div>
                    <div class="file-details">
                        <div class="file-name" id="pose-image-filename"></div>
                        <div class="file-size" id="pose-image-filesize"></div>
                    </div>
                    <button class="file-remove" id="pose-image-remove">Ã—</button>
                </div>
            </div>
        </div>

        <!-- æç¤ºè¯1è¾“å…¥ -->
        <div class="card">
            <div class="card-title">
                <div class="icon">âœï¸</div>
                è¾“å…¥æç¤ºè¯1ï¼ˆä¸»è¦æè¿°ï¼‰
            </div>

            <div class="prompt-area">
                <label class="prompt-label">æè¿°ä½ æƒ³è¦çš„äººç‰©åŠ¨ä½œå’Œæœè£…å˜åŒ–</label>
                <div class="prompt-hint">
                    é»˜è®¤æç¤ºè¯ä¼šå°†å›¾1çš„äººç‰©æ¢æˆå›¾2çš„å§¿åŠ¿ã€‚ä½ å¯ä»¥ä¿®æ”¹æè¿°æ¥æ”¹å˜æœè£…ç­‰ç»†èŠ‚ã€‚
                </div>
                <textarea
                    class="prompt-input"
                    id="prompt1-input"
                    placeholder="ä¾‹å¦‚ï¼šå›¾1ä¸­çš„äººç‰©æ¢æˆå›¾2çš„å§¿åŠ¿ï¼Œè¡£æœæ¢æˆæ¯”åŸºå°¼"
                >å›¾1ä¸­çš„äººç‰©æ¢æˆå›¾2çš„å§¿åŠ¿ï¼Œè¡£æœæ¢æˆæ¯”åŸºå°¼</textarea>
                <div class="prompt-examples">
                    <span class="prompt-example" data-target="prompt1-input" data-prompt="å›¾1ä¸­çš„äººç‰©æ¢æˆå›¾2çš„å§¿åŠ¿ï¼Œè¡£æœæ¢æˆæ¯”åŸºå°¼">ğŸ‘™ æ¯”åŸºå°¼</span>
                    <span class="prompt-example" data-target="prompt1-input" data-prompt="å›¾1ä¸­çš„äººç‰©æ¢æˆå›¾2çš„å§¿åŠ¿ï¼Œè¡£æœæ¢æˆæ™šç¤¼æœ">ğŸ‘— æ™šç¤¼æœ</span>
                    <span class="prompt-example" data-target="prompt1-input" data-prompt="å›¾1ä¸­çš„äººç‰©æ¢æˆå›¾2çš„å§¿åŠ¿ï¼Œè¡£æœæ¢æˆè¿åŠ¨è£…">ğŸ‘Ÿ è¿åŠ¨è£…</span>
                    <span class="prompt-example" data-target="prompt1-input" data-prompt="å›¾1ä¸­çš„äººç‰©æ¢æˆå›¾2çš„å§¿åŠ¿ï¼Œè¡£æœæ¢æˆä¼‘é—²è£…">ğŸ‘• ä¼‘é—²è£…</span>
                </div>
            </div>
        </div>

        <!-- æç¤ºè¯2è¾“å…¥ -->
        <div class="card">
            <div class="card-title">
                <div class="icon">ğŸ¨</div>
                è¾“å…¥æç¤ºè¯2ï¼ˆå§¿åŠ¿æè¿°ï¼‰
            </div>

            <div class="prompt-area">
                <label class="prompt-label">å§¿åŠ¿æè¿°æç¤ºè¯</label>
                <div class="prompt-hint">
                    ç”¨äºæŒ‡å¯¼AIå¦‚ä½•æè¿°å§¿åŠ¿å‚è€ƒå›¾ä¸­çš„å§¿åŠ¿ã€‚ä¸€èˆ¬ä¸éœ€è¦ä¿®æ”¹ã€‚
                </div>
                <textarea
                    class="prompt-input"
                    id="prompt2-input"
                    placeholder="ä¾‹å¦‚ï¼šå¸®æˆ‘æè¿°å›¾ç‰‡ä¸­äººç‰©çš„å§¿åŠ¿å’Œæœå‘..."
                >å¸®æˆ‘æè¿°å›¾ç‰‡ä¸­äººç‰©çš„å§¿åŠ¿å’Œæœå‘ï¼Œåªéœ€è¦æè¿°å§¿åŠ¿å’Œæœå‘ï¼Œå…¶ä»–å…³äºèƒŒæ™¯å’Œäººç‰©ä¿¡æ¯ä¸€å¾‹ä¸è¦æè¿°ï¼Œæœ€åç»“æœä¸å¸¦ä»»ä½•è§£é‡Šæ€§æ–‡å­—ï¼Œæœ€åæ ¼å¼æŒ‰ç…§ä»¥ä¸‹è¾“å‡ºï¼šåŒè…¿äº¤å‰ååœ¨åœ°ä¸Šï¼ŒåŒæ‰‹æ’‘åœ°ï¼Œå¤´å¾®å¾®åå‘ä¸€ä¾§ã€‚</textarea>
            </div>
        </div>

        <button class="btn btn-primary" id="submit-btn" disabled>
            å¼€å§‹ç”Ÿæˆ
        </button>

        <!-- æŸ¥è¯¢å†å²ä»»åŠ¡ -->
        <div class="card" style="margin-top: 20px; background: #f8f9fa;">
            <div class="card-title">
                <div class="icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ”</div>
                æŸ¥è¯¢å†å²ä»»åŠ¡
            </div>
            <div class="prompt-area">
                <label class="prompt-label">å·²æœ‰ä»»åŠ¡IDï¼Ÿè¾“å…¥ä»»åŠ¡IDæŸ¥è¯¢ç»“æœ</label>
                <div style="display: flex; gap: 10px;">
                    <input
                        type="text"
                        class="prompt-input"
                        id="task-id-input"
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡IDï¼Œä¾‹å¦‚ï¼š1904152026220003329"
                        style="min-height: 44px; flex: 1;"
                    >
                    <button class="btn btn-primary" id="query-task-btn" style="margin-top: 0; width: auto; padding: 12px 24px;">
                        æŸ¥è¯¢
                    </button>
                </div>
            </div>
        </div>

        <div class="progress-area" id="progress-area">
            <div class="progress-spinner"></div>
            <div class="progress-text">æ­£åœ¨å¤„ç†ä¸­...</div>
            <div class="progress-status" id="progress-status">å‡†å¤‡ä¸Šä¼ </div>
        </div>

        <div class="result-area" id="result-area">
            <div class="result-title">âœ… å¤„ç†å®Œæˆ</div>
            <div id="result-list"></div>
        </div>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="toast" id="toast"></div>

    <script>
        // å…¨å±€å˜é‡
        let selectedSourceImageFile = null;
        let selectedPoseImageFile = null;
        let currentTaskId = null;

        // DOMå…ƒç´ 
        const toast = document.getElementById('toast');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initSourceImageUpload();
            initPoseImageUpload();
            initPromptExamples();
            initSubmit();
            initQueryTask();
            loadWorkflowPrompts(); // åŠ è½½å·¥ä½œæµé»˜è®¤æç¤ºè¯
        });

        // ä»æœåŠ¡å™¨åŠ è½½å·¥ä½œæµé»˜è®¤æç¤ºè¯
        async function loadWorkflowPrompts() {
            try {
                const response = await fetch('/api/get_workflow_prompts');
                const result = await response.json();

                if (result.code === 0 && result.data) {
                    const prompt1Input = document.getElementById('prompt1-input');
                    const prompt2Input = document.getElementById('prompt2-input');

                    if (result.data.prompt1 && prompt1Input) {
                        prompt1Input.value = result.data.prompt1;
                    }
                    if (result.data.prompt2 && prompt2Input) {
                        prompt2Input.value = result.data.prompt2;
                    }

                    console.log('å·²åŠ è½½å·¥ä½œæµé»˜è®¤æç¤ºè¯:', result.data);
                }
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œæµæç¤ºè¯å¤±è´¥:', error);
                // å¤±è´¥æ—¶ä½¿ç”¨HTMLä¸­çš„é»˜è®¤å€¼
            }
        }

        // åŸå›¾ä¸Šä¼ 
        function initSourceImageUpload() {
            const uploadArea = document.getElementById('source-image-upload');
            const fileInput = document.getElementById('source-image-input');
            const preview = document.getElementById('source-image-preview');
            const previewImg = document.getElementById('source-preview-img');
            const filename = document.getElementById('source-image-filename');
            const filesize = document.getElementById('source-image-filesize');
            const removeBtn = document.getElementById('source-image-remove');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleSourceImageFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleSourceImageFile(e.target.files[0]);
                }
            });

            removeBtn.addEventListener('click', () => {
                selectedSourceImageFile = null;
                fileInput.value = '';
                preview.classList.remove('show');
                uploadArea.style.display = 'block';
                updateSubmitButton();
            });

            function handleSourceImageFile(file) {
                const allowedExts = ['png', 'jpg', 'jpeg'];
                const ext = file.name.split('.').pop().toLowerCase();

                if (!allowedExts.includes(ext)) {
                    showToast('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼  PNG æˆ– JPG å›¾ç‰‡', 'error');
                    return;
                }

                selectedSourceImageFile = file;
                filename.textContent = file.name;
                filesize.textContent = formatFileSize(file.size);

                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                };
                reader.readAsDataURL(file);

                preview.classList.add('show');
                uploadArea.style.display = 'none';
                updateSubmitButton();
            }
        }

        // å§¿åŠ¿å‚è€ƒå›¾ä¸Šä¼ 
        function initPoseImageUpload() {
            const uploadArea = document.getElementById('pose-image-upload');
            const fileInput = document.getElementById('pose-image-input');
            const preview = document.getElementById('pose-image-preview');
            const previewImg = document.getElementById('pose-preview-img');
            const filename = document.getElementById('pose-image-filename');
            const filesize = document.getElementById('pose-image-filesize');
            const removeBtn = document.getElementById('pose-image-remove');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handlePoseImageFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePoseImageFile(e.target.files[0]);
                }
            });

            removeBtn.addEventListener('click', () => {
                selectedPoseImageFile = null;
                fileInput.value = '';
                preview.classList.remove('show');
                uploadArea.style.display = 'block';
                updateSubmitButton();
            });

            function handlePoseImageFile(file) {
                const allowedExts = ['png', 'jpg', 'jpeg'];
                const ext = file.name.split('.').pop().toLowerCase();

                if (!allowedExts.includes(ext)) {
                    showToast('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼  PNG æˆ– JPG å›¾ç‰‡', 'error');
                    return;
                }

                selectedPoseImageFile = file;
                filename.textContent = file.name;
                filesize.textContent = formatFileSize(file.size);

                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                };
                reader.readAsDataURL(file);

                preview.classList.add('show');
                uploadArea.style.display = 'none';
                updateSubmitButton();
            }
        }

        // æç¤ºè¯ç¤ºä¾‹
        function initPromptExamples() {
            const examples = document.querySelectorAll('.prompt-example');

            examples.forEach(example => {
                example.addEventListener('click', () => {
                    const targetId = example.dataset.target;
                    const promptInput = document.getElementById(targetId);
                    if (promptInput) {
                        promptInput.value = example.dataset.prompt;
                        updateSubmitButton();
                    }
                });
            });

            document.getElementById('prompt1-input').addEventListener('input', updateSubmitButton);
            document.getElementById('prompt2-input').addEventListener('input', updateSubmitButton);
        }

        // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            const prompt1Input = document.getElementById('prompt1-input');
            const hasSourceFile = selectedSourceImageFile !== null;
            const hasPoseFile = selectedPoseImageFile !== null;
            const hasPrompt1 = prompt1Input.value.trim().length > 0;
            submitBtn.disabled = !(hasSourceFile && hasPoseFile && hasPrompt1);
        }

        // æäº¤æŒ‰é’®
        function initSubmit() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.addEventListener('click', processImage);
        }

        // æŸ¥è¯¢å†å²ä»»åŠ¡æŒ‰é’®
        function initQueryTask() {
            const queryBtn = document.getElementById('query-task-btn');
            const taskIdInput = document.getElementById('task-id-input');

            queryBtn.addEventListener('click', async () => {
                const taskId = taskIdInput.value.trim();
                if (!taskId) {
                    showToast('è¯·è¾“å…¥ä»»åŠ¡ID', 'error');
                    return;
                }

                await queryExistingTask(taskId);
            });

            // æ”¯æŒå›è½¦é”®æŸ¥è¯¢
            taskIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    queryBtn.click();
                }
            });
        }

        // æŸ¥è¯¢å·²æœ‰ä»»åŠ¡
        async function queryExistingTask(taskId) {
            const progressArea = document.getElementById('progress-area');
            const statusText = document.getElementById('progress-status');
            const resultArea = document.getElementById('result-area');
            const queryBtn = document.getElementById('query-task-btn');

            queryBtn.disabled = true;
            progressArea.classList.add('show');
            resultArea.classList.remove('show');

            try {
                // 1. å…ˆæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
                statusText.textContent = 'æ­£åœ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€...';
                const statusResult = await queryStatus(taskId);

                if (statusResult.code !== 0) {
                    throw new Error(statusResult.msg || 'æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥');
                }

                const status = statusResult.data;
                console.log(`[queryExistingTask] ä»»åŠ¡çŠ¶æ€: ${status}`);

                if (status === 'SUCCESS') {
                    // ä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥è·å–ç»“æœ
                    statusText.textContent = 'ä»»åŠ¡å·²å®Œæˆï¼Œæ­£åœ¨è·å–ç»“æœ...';
                    const outputsResult = await getOutputs(taskId);

                    if (outputsResult.code !== 0) {
                        throw new Error(outputsResult.msg || 'è·å–ç»“æœå¤±è´¥');
                    }

                    progressArea.classList.remove('show');
                    displayResults(outputsResult.data);
                    resultArea.classList.add('show');
                    showToast('ç»“æœè·å–æˆåŠŸ', 'success');
                } else if (status === 'FAILED') {
                    throw new Error('ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                } else if (status === 'QUEUED' || status === 'RUNNING' || status === 'CREATE') {
                    // ä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå¼€å§‹è½®è¯¢
                    statusText.textContent = `ä»»åŠ¡${getStatusText(status)}ï¼Œç»§ç»­ç­‰å¾…...`;
                    const outputs = await pollTaskStatus(taskId, (s) => {
                        statusText.textContent = `ä»»åŠ¡çŠ¶æ€: ${getStatusText(s)}`;
                    });

                    progressArea.classList.remove('show');
                    displayResults(outputs);
                    resultArea.classList.add('show');
                    showToast('å¤„ç†å®Œæˆ', 'success');
                } else {
                    throw new Error(`æœªçŸ¥ä»»åŠ¡çŠ¶æ€: ${status}`);
                }

            } catch (error) {
                progressArea.classList.remove('show');
                showToast(error.message || 'æŸ¥è¯¢å¤±è´¥', 'error');
                console.error(error);
            } finally {
                queryBtn.disabled = false;
            }
        }

        // å¤„ç†å›¾ç‰‡
        async function processImage() {
            const progressArea = document.getElementById('progress-area');
            const statusText = document.getElementById('progress-status');
            const resultArea = document.getElementById('result-area');
            const submitBtn = document.getElementById('submit-btn');
            const prompt1Input = document.getElementById('prompt1-input');
            const prompt2Input = document.getElementById('prompt2-input');

            submitBtn.disabled = true;
            progressArea.classList.add('show');
            resultArea.classList.remove('show');

            try {
                // 1. ä¸Šä¼ åŸå›¾
                statusText.textContent = 'æ­£åœ¨ä¸Šä¼ åŸå›¾...';
                const sourceUploadResult = await uploadFile(selectedSourceImageFile, 'image');

                if (sourceUploadResult.code !== 0) {
                    throw new Error(sourceUploadResult.msg || 'åŸå›¾ä¸Šä¼ å¤±è´¥');
                }

                const sourceFileName = sourceUploadResult.data.fileName;
                showToast('åŸå›¾ä¸Šä¼ æˆåŠŸ', 'success');

                // 2. ä¸Šä¼ å§¿åŠ¿å‚è€ƒå›¾
                statusText.textContent = 'æ­£åœ¨ä¸Šä¼ å§¿åŠ¿å‚è€ƒå›¾...';
                const poseUploadResult = await uploadFile(selectedPoseImageFile, 'image');

                if (poseUploadResult.code !== 0) {
                    throw new Error(poseUploadResult.msg || 'å§¿åŠ¿å‚è€ƒå›¾ä¸Šä¼ å¤±è´¥');
                }

                const poseFileName = poseUploadResult.data.fileName;
                showToast('å§¿åŠ¿å‚è€ƒå›¾ä¸Šä¼ æˆåŠŸ', 'success');

                // 3. åˆ›å»ºä»»åŠ¡
                statusText.textContent = 'æ­£åœ¨åˆ›å»ºä»»åŠ¡...';
                const prompt1 = prompt1Input.value.trim();
                const prompt2 = prompt2Input.value.trim();
                const taskResult = await createPoseTask(sourceFileName, poseFileName, prompt1, prompt2);

                if (taskResult.code !== 0) {
                    throw new Error(taskResult.msg || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                }

                currentTaskId = taskResult.data.taskId;
                showToast('ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');

                // 4. è½®è¯¢çŠ¶æ€
                statusText.textContent = 'æ­£åœ¨å¤„ç†ä¸­...';
                const outputs = await pollTaskStatus(currentTaskId, (status) => {
                    statusText.textContent = `ä»»åŠ¡çŠ¶æ€: ${getStatusText(status)}`;
                });

                // 5. æ˜¾ç¤ºç»“æœ
                progressArea.classList.remove('show');
                displayResults(outputs);
                resultArea.classList.add('show');
                showToast('å¤„ç†å®Œæˆ', 'success');

            } catch (error) {
                progressArea.classList.remove('show');
                submitBtn.disabled = false;
                showToast(error.message || 'å¤„ç†å¤±è´¥', 'error');
                console.error(error);
            }
        }

        // APIè°ƒç”¨
        async function uploadFile(file, type) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', type);

            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            return await response.json();
        }

        async function createPoseTask(sourceFileName, poseFileName, prompt1, prompt2) {
            const response = await fetch('/api/create_pose_task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sourceFileName, poseFileName, prompt1, prompt2 })
            });

            return await response.json();
        }

        async function queryStatus(taskId) {
            const response = await fetch('/api/query_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId })
            });

            return await response.json();
        }

        async function getOutputs(taskId) {
            const response = await fetch('/api/get_outputs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId })
            });

            return await response.json();
        }

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollTaskStatus(taskId, onStatusChange) {
            const maxRetries = 60;
            const interval = 5000; // 5ç§’

            for (let i = 0; i < maxRetries; i++) {
                const result = await queryStatus(taskId);

                if (result.code !== 0) {
                    throw new Error(result.msg || 'æŸ¥è¯¢çŠ¶æ€å¤±è´¥');
                }

                const status = result.data;
                onStatusChange(status);

                if (status === 'SUCCESS') {
                    const outputsResult = await getOutputs(taskId);
                    if (outputsResult.code === 0) {
                        return outputsResult.data;
                    }
                    throw new Error('è·å–è¾“å‡ºå¤±è´¥');
                } else if (status === 'FAILED') {
                    throw new Error('ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                }

                await new Promise(resolve => setTimeout(resolve, interval));
            }

            throw new Error('å¤„ç†è¶…æ—¶');
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(outputs) {
            console.log('[displayResults] æ¥æ”¶åˆ°çš„æ•°æ®:', outputs);
            const container = document.getElementById('result-list');
            container.innerHTML = '';

            if (!outputs || outputs.length === 0) {
                console.log('[displayResults] æ²¡æœ‰è¾“å‡ºæ•°æ®');
                container.innerHTML = '<div style="text-align: center; color: #999;">æ²¡æœ‰ç”Ÿæˆç»“æœ</div>';
                return;
            }

            outputs.forEach((item, index) => {
                console.log(`[displayResults] å¤„ç†ç¬¬ ${index + 1} ä¸ªç»“æœ:`, item);
                const div = document.createElement('div');
                div.className = 'result-item';

                const localUrl = item.localUrl || item.fileUrl;
                console.log(`[displayResults] ä½¿ç”¨ URL: ${localUrl}`);

                div.innerHTML = `
                    <img class="result-preview" src="${localUrl}" alt="ç»“æœ${index + 1}" onerror="this.src='${item.fileUrl}'">
                    <div class="result-actions">
                        <a href="${localUrl}" download class="btn-download">ä¸‹è½½å›¾ç‰‡</a>
                    </div>
                `;

                container.appendChild(div);
            });

            document.getElementById('submit-btn').disabled = false;
        }

        // å·¥å…·å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusText(status) {
            const statusMap = {
                'CREATE': 'åˆ›å»ºä¸­',
                'QUEUED': 'æ’é˜Ÿä¸­',
                'RUNNING': 'å¤„ç†ä¸­',
                'SUCCESS': 'å®Œæˆ',
                'FAILED': 'å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = `toast ${type}`;

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
